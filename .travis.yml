dist: trusty

# Sudo is required for docker daemon
sudo: required

language: node_js

# Enable Docker
services:
  - docker

# Allow building on the following branches only
# the regular expression on the end is for TAGS because
# when a tag is deployed, it is treated also as a branch
# in these scripts (i.e, $TRAVIS_TAG = $TRAVIS_BRANC)
branches:
  only:
  - master
  - stable
  - petong/travis-ci
  - "/^v\\d+\\.\\d+\\.\\d+(-\\d+)?$/"

node_js:
- '9'
- '8'

# Add some apt packages for libusb to enable ledger support
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - gcc-4.8
    - g++-4.8
    - build-essential
    - libusb-1.0-0-dev

# Scripts that will be run during the test phase. If this phase doesn't
# complete the deploy phase will not run


# Build docker image and push
jobs:
  include:
    - script: yarn lint; yarn test;
    - script: NODE_ENV='test' node ./node_modules/nyc/bin/nyc.js ./node_modules/mocha/bin/_mocha --timeout 10000 --require babel-register && node ./node_modules/nyc/bin/nyc.js report --require babel-register --reporter=lcov && cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js
    - script: build --dev
    - stage: deploy
      if: branch IN (stable, petong/travis-ci)
      node_js: '8'
      deploy: &script
        script: docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"; travis_wait npm run docker:release:stable;
        skip_cleanup: true

env:
  global:
    - DOCKER_USERNAME=augurintegration
    - secure: "hfHRWYqUxQ7Ow4wsG0hJ21wtGjGpy95CuDg0maxtMxq6lsYvy0yfNawH5psX1P9cyiwWY6ryxeoD9HBx3McKbEG9vWhg4pZ63ghnwEAWMtIDq+cfhTAXenlHG+P/owJCzhch+okj77iYioXCUQccqzGl0OCyoHUgFlWZCcRb+RM="

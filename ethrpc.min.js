/**
 * Send JSON-RPC commands to Ethereum from the safety and convenience of
 * your browser!
 * 
 * @author Jack Peterson (jack@augur.net)
 * @date 4/12/2015
 * @license MIT
 */
function log(t){var r="[ethrpc.js] ";t&&(r+=t.constructor==Object||t.constructor==Array?JSON.stringify(t,null,2):t.toString(),console.log(r))}function parse_array(t,r,n,e){r=r||64;for(var a=(t.length-2)/r,o=Array(a),s=n||2,c=0;a>c;++c)o[c]="0x"+t.slice(s,s+r),e&&(o[c]=new BigNumber(o[c])),s+=r;return o}function encode_int(t){for(var r=[];t>0;)r.push(String.fromCharCode(t%256)),t=Math.floor(t/256);return r.reverse().join("")}function encode_hex(t){for(var r="",n=0,e=t.length;e>n;++n)r+=t.charCodeAt(n).toString(16);return r}function zeropad(t,r){var n=t;for(r||(n=encode_hex(n));n.length<64;)n="0"+n;return n}function encode_abi(t,r,n,e){if(e){for(var a,o="",s=0,c=t.length;c>s;++s)a=encode_any(t[s],r,n,e.slice(0,-1)),o+=a.normal_args;return{len_args:zeropad(encode_int(t.length)),normal_args:"",var_args:o}}var i="",u="",p="";return"string"===r&&(i=zeropad(encode_int(t.length)),p=t),"int"===r&&(t.constructor===Number?u=zeropad(encode_int(t%Math.pow(2,n))):t.constructor===String&&(u="0x"===t.slice(0,2)?zeropad(t.slice(2),!0):zeropad(encode_int(parseInt(t)%Math.pow(2,n))))),{len_args:i,normal_args:u,var_args:p}}function get_prefix(t,r){r=r||"";for(var n=t+"(",e=0,a=r.length;a>e;++e){switch(r[e]){case"s":n+="string";break;case"i":n+="int256";break;case"a":n+="int256[]";break;default:n+="weird"}e!=a-1&&(n+=",")}return n+=")","0x"+keccak_256(n).slice(0,8)}function clone(t){if(null==t||"object"!=typeof t)return t;var r=t.constructor();for(var n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);return r}function parse(t,r){if(t=JSON.parse(t),t.error)console.error("["+t.error.code+"]",t.error.message);else{if(!rpc.async)return t.result&&r?r(t):t.result?t.result:t;t.result&&r?r(t):log(t.result?t.result:t)}}function postdata(t,r,n){return pdata={id:id++,jsonrpc:"2.0"},pdata.method="null"===n?t.toString():(n||"eth_")+t.toString(),pdata.params=r?r.constructor===Array?r:[r]:[],JSON.stringify(pdata)}function json_rpc(t,r){var n=null;if(NODE_JS){if(!rpc.async)return n=httpsync.request({protocol:rpc.protocol,host:rpc.host,path:"/",port:rpc.port,method:"POST"}),n.write(t),parse(n.end().body.toString(),r);n=new XMLHttpRequest,n.onreadystatechange=function(){4==n.readyState&&parse(n.responseText,r)},n.open("POST",rpc_url,!0),n.setRequestHeader("Content-type","application/json"),n.send(t)}else{if(n=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),!rpc.async)return n.open("POST",rpc_url,!1),n.setRequestHeader("Content-type","application/json"),n.send(t),parse(n.responseText,r);n.onreadystatechange=function(){4==n.readyState&&parse(n.responseText,r)},n.open("POST",rpc_url,!0),n.setRequestHeader("Content-type","application/json"),n.send(t)}}var rpc={protocol:"http",host:"127.0.0.1",port:8545,async:!1},NODE_JS="undefined"!=typeof module;if(NODE_JS)var http=require("http"),httpsync=require("http-sync"),keccak_256=require("js-sha3").keccak_256,BigNumber=require("bignumber.js"),XMLHttpRequest=require("xhr2");var pdata,id=1,rpc_url=rpc.protocol+"://"+rpc.host+":"+rpc.port.toString(),default_gas="0x2dc6c0",EthRPC={rpc:function(t,r,n){return json_rpc(postdata(t,r,"null"),n)},eth:function(t,r,n){return json_rpc(postdata(t,r),n)},net:function(t,r,n){return json_rpc(postdata(t,r,"net_"),n)},web3:function(t,r,n){return json_rpc(postdata(t,r,"web3_"),n)},db:function(t,r,n){return json_rpc(postdata(t,r,"db_"),n)},shh:function(t,r,n){return json_rpc(postdata(t,r,"shh_"),n)},hash:function(t,r,n){return t?((t.constructor===Array||t.constructor===Object)&&(t=JSON.stringify(t)),json_rpc(postdata("sha3",t.toString(),"web3_"),function(t){var e=r?t.result.slice(0,10):t.result;return n?n(e):e})):void 0},gasPrice:function(t){return json_rpc(postdata("gasPrice"),function(r){var n=parseInt(r.result);return t?t(n):n})},blockNumber:function(t){return json_rpc(postdata("blockNumber"),function(r){var n=parseInt(r.result);return t?t(n):n})},balance:function(t,r,n){return json_rpc(postdata("getBalance",[t,r||"latest"]),n||function(t){return parseInt(t.result,16)/1e18})},txCount:function(t,r){return json_rpc(postdata("getTransactionCount",t),r)},call:function(t,r){return t.to=t.to||"",t.gas=t.gas?"0x"+t.gas.toString(16):default_gas,json_rpc(postdata("call",t),r)},sendTx:function(t,r){return t.to=t.to||"",t.gas=t.gas?"0x"+t.gas.toString(16):default_gas,json_rpc(postdata("sendTransaction",t),r)},pay:function(t,r,n){return this.sendTx({from:this.coinbase(),to:t,value:r},n)},getTx:function(t,r){return json_rpc(postdata("getTransactionByHash",t),r)},peerCount:function(t){return parseInt(json_rpc(postdata("peerCount",[],"net_"),t))},coinbase:function(t){return json_rpc(postdata("coinbase"),t)},publish:function(t,r){return this.sendTx({from:this.coinbase(),data:t},r)},abi_data:function(t){t.signature=t.signature||"";for(var r=get_prefix(t["function"],t.signature),n=[],e=0,a=t.signature.length;a>e;++e)n.push("s"==t.signature[e]?"string":"a"==t.signature[e]?"int256[]":"int256");t.params?t.params.constructor===String?("["===t.params.slice(0,1)&&"]"===t.params.slice(-1)&&(t.params=JSON.parse(t.params)),t.params.constructor===String&&(t.params=[t.params])):t.params.constructor===Number&&(t.params=[t.params]):t.params=[];var o,s,c,i="",u="",p="";if(n.length!=t.params.length)return console.error("wrong number of parameters");for(e=0,a=n.length;a>e;++e)"string"===n[e]?(o="string",s=""):"int256[]"===n[e]?(o="int",s=256,c="[]"):(o="int",s=256),res=encode_abi(t.params[e],o,s,c),i+=res.len_args,u+=res.normal_args,p+=res.var_args;return r+=i+u+p},invoke:function(t,r){var t=clone(t);if(data_abi=this.abi_data(t),t&&data_abi){var n={from:t.from||this.coinbase(),to:t.to,data:data_abi},e=t.send?this.sendTx:this.call,a=e(n,r);if(t.returns)try{"array"===t.returns.toLowerCase()?a=parse_array(a):"int"===t.returns.toLowerCase()?a=parseInt(a):"bignumber"===t.returns.toLowerCase()&&(a=new BigNumber(a))}catch(o){log(o)}return a}},read:function(t,r,n){return t?json_rpc(postdata("getCode",[t,r||"latest"]),n):void 0},id:function(){return id},data:function(){return pdata},sha3:function(t,r){return this.hash(t,r)},getBalance:function(t,r,n){return this.balance(t,r,n)},getTransactionCount:function(t,r){return this.txCount(t,r)},sendTransaction:function(t,r){return this.sendTx(t,r)},getTransactionByHash:function(t,r){return this.getTx(t,r)},getCode:function(t,r,n){return this.read(t,r,n)},run:function(t,r){this.invoke(t,r)},execute:function(t,r){this.invoke(t,r)}};NODE_JS&&(module.exports=EthRPC);
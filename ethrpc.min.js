/**
 * Asynchronous, browser-compatible JSON-RPC for Ethereum
 * 
 * @author Jack Peterson (jack@tinybike.net)
 * @license MIT
 */
function log(r){var t="[ethrpc.js] ";r&&(t+=r.constructor==Object||r.constructor==Array?JSON.stringify(r,null,2):r.toString(),console.log(t))}function parse_array(r,t,n,e){t=t||64;for(var a=(r.length-2)/t,s=Array(a),o=n||2,c=0;a>c;++c)s[c]="0x"+r.slice(o,o+t),e&&(s[c]=new BigNumber(s[c])),o+=t;return s}function encode_int(r){for(var t=[];r>0;)t.push(String.fromCharCode(r%256)),r=Math.floor(r/256);return t.reverse().join("")}function encode_hex(r){for(var t,n="",e=0,a=r.length;a>e;++e)t=r.charCodeAt(e).toString(16),1===t.length&&(t="0"+t),n+=t;return n}function zeropad(r,t){var n=r;for(t||(n=encode_hex(n));n.length<64;)n="0"+n;return n}function encode_abi(r,t,n,e){if(e&&"[]"===e.slice(-2)){for(var a,s="",o=0,c=r.length;c>o;++o)a=encode_abi(r[o],t,n,e.slice(0,-1)),s+=a.normal_args;return{len_args:zeropad(encode_int(r.length)),normal_args:"",var_args:s}}var i=normal_args=var_args="";return"string"===t&&(i=zeropad(encode_int(r.length)),var_args=encode_hex(r)),"int"===t&&(r.constructor===Number?normal_args=zeropad(encode_int(r%Math.pow(2,n))):r.constructor===String&&(normal_args="0x"===r.slice(0,2)?zeropad(r.slice(2),!0):zeropad(encode_int(parseInt(r)%Math.pow(2,n))))),{len_args:i,normal_args:normal_args,var_args:var_args}}function get_prefix(r,t){t=t||"";for(var n=r+"(",e=0,a=t.length;a>e;++e){switch(t[e]){case"s":n+="string";break;case"i":n+="int256";break;case"a":n+="int256[]";break;default:n+="weird"}e!=a-1&&(n+=",")}for(var s=keccak_256(n+")").slice(0,8);"0"===s.slice(0,1);)s=s.slice(1);return"0x"+s}function clone(r){if(null==r||"object"!=typeof r)return r;var t=r.constructor();for(var n in r)r.hasOwnProperty(n)&&(t[n]=r[n]);return t}function parse(r,t){if(r=JSON.parse(r),r.error)console.error("["+r.error.code+"]",r.error.message);else{if(!(rpc.async&&r.result&&t))return r.result&&t?t(r):r.result?r.result:r;t(r)}}function postdata(r,t,n){return pdata={id:id++,jsonrpc:"2.0"},pdata.method="null"===n?r.toString():(n||"eth_")+r.toString(),pdata.params=t?t.constructor===Array?t:[t]:[],JSON.stringify(pdata)}function json_rpc(r,t,n){var e=null;if(NODE_JS){if(!t&&!rpc.async)return e=httpsync.request({protocol:rpc.protocol,host:rpc.host,path:"/",port:rpc.port,method:"POST"}),e.write(r),parse(e.end().body.toString(),n);e=new XMLHttpRequest,e.onreadystatechange=function(){4==e.readyState&&parse(e.responseText,n)},e.open("POST",rpc_url,!0),e.setRequestHeader("Content-type","application/json"),e.send(r)}else{if(e=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),!t&&!rpc.async)return e.open("POST",rpc_url,!1),e.setRequestHeader("Content-type","application/json"),e.send(r),parse(e.responseText,n);e.onreadystatechange=function(){4==e.readyState&&parse(e.responseText,n)},e.open("POST",rpc_url,!0),e.setRequestHeader("Content-type","application/json"),e.send(r)}}function format_result(r,t){try{"array"===r?t=parse_array(t):"int"===r?t=parseInt(t):"bignumber"===r&&(t=new BigNumber(t))}catch(n){log(n)}return t}var rpc={protocol:"http",host:"127.0.0.1",port:8545,async:!0},NODE_JS="undefined"!=typeof module;if(NODE_JS)var http=require("http"),httpsync=require("http-sync"),keccak_256=require("js-sha3").keccak_256,BigNumber=require("bignumber.js"),XMLHttpRequest=require("xhr2");var pdata,id=1,rpc_url=rpc.protocol+"://"+rpc.host+":"+rpc.port.toString(),default_gas="0x2dc6c0",EthRPC={async:rpc.async,rpc:function(r,t,n){return json_rpc(postdata(r,t,"null"),rpc.async,n)},eth:function(r,t,n){return json_rpc(postdata(r,t),rpc.async,n)},net:function(r,t,n){return json_rpc(postdata(r,t,"net_"),rpc.async,n)},web3:function(r,t,n){return json_rpc(postdata(r,t,"web3_"),rpc.async,n)},db:function(r,t,n){return json_rpc(postdata(r,t,"db_"),rpc.async,n)},shh:function(r,t,n){return json_rpc(postdata(r,t,"shh_"),rpc.async,n)},hash:function(r,t,n){return r?((r.constructor===Array||r.constructor===Object)&&(r=JSON.stringify(r)),json_rpc(postdata("sha3",r.toString(),"web3_"),rpc.async,function(r){var e=t?r.result.slice(0,10):r.result;return n?n(e):e})):void 0},gasPrice:function(r){return json_rpc(postdata("gasPrice"),rpc.async,function(t){var n=parseInt(t.result);return r?r(n):n})},blockNumber:function(r){return json_rpc(postdata("blockNumber"),rpc.async,function(t){var n=parseInt(t.result);return r?r(n):n})},balance:function(r,t,n){return json_rpc(postdata("getBalance",[r,t||"latest"]),rpc.async,n||function(r){var t=new BigNumber(r.result).dividedBy(new BigNumber(10).toPower(18));return rpc.async?void log(t):t.toNumber()})},txCount:function(r,t){return json_rpc(postdata("getTransactionCount",r),rpc.async,t)},call:function(r,t){return r.to=r.to||"",r.gas=r.gas?"0x"+r.gas.toString(16):default_gas,json_rpc(postdata("call",r),rpc.async,t)},sendTx:function(r,t){return r.to=r.to||"",r.gas=r.gas?"0x"+r.gas.toString(16):default_gas,json_rpc(postdata("sendTransaction",r),rpc.async,t)},pay:function(r,t,n,e){return this.sendTx({from:r||this.coinbase(),to:t,value:n},e)},getTx:function(r,t){return json_rpc(postdata("getTransactionByHash",r),rpc.async,t)},peerCount:function(r){return rpc.async?json_rpc(postdata("peerCount",[],"net_"),rpc.async,r):parseInt(json_rpc(postdata("peerCount",[],"net_"),rpc.async,r))},coinbase:function(r){return json_rpc(postdata("coinbase"),rpc.async,r)},publish:function(r,t){return this.sendTx({from:this.coinbase(),data:r},t)},abi_data:function(r){r.signature=r.signature||"";for(var t=get_prefix(r["function"],r.signature),n=[],e=0,a=r.signature.length;a>e;++e)n.push("s"==r.signature[e]?"string":"a"==r.signature[e]?"int256[]":"int256");r.params?r.params.constructor===String?("["===r.params.slice(0,1)&&"]"===r.params.slice(-1)&&(r.params=JSON.parse(r.params)),r.params.constructor===String&&(r.params=[r.params])):r.params.constructor===Number&&(r.params=[r.params]):r.params=[];var s,o,c,i="",u="",p="";if(n.length!=r.params.length)return console.error("wrong number of parameters");for(e=0,a=n.length;a>e;++e)"string"===n[e]?(s="string",o=""):"int256[]"===n[e]?(s="int",o=256,c="[]"):(s="int",o=256),res=encode_abi(r.params[e],s,o,c),i+=res.len_args,u+=res.normal_args,p+=res.var_args;return t+=i+u+p},invoke:function(r,t){var n,e,a;if(r){var r=clone(r);if(data_abi=this.abi_data(r),data_abi){if(n={from:r.from||this.coinbase(),to:r.to,data:data_abi},e=r.send?this.sendTx:this.call,!rpc.async)return a=e(n,t),r.returns&&(a=format_result(r.returns.toLowerCase(),a)),a;a=e(n,t)}}},read:function(r,t,n){return r?json_rpc(postdata("getCode",[r,t||"latest"]),rpc.async,n):void 0},id:function(){return id},data:function(){return pdata},sha3:function(r,t){return this.hash(r,t)},getBalance:function(r,t,n){return this.balance(r,t,n)},getTransactionCount:function(r,t){return this.txCount(r,t)},sendTransaction:function(r,t){return this.sendTx(r,t)},getTransactionByHash:function(r,t){return this.getTx(r,t)},getCode:function(r,t,n){return this.read(r,t,n)},run:function(r,t){this.invoke(r,t)},execute:function(r,t){this.invoke(r,t)}};NODE_JS&&(module.exports=EthRPC);